<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWL Validation</title>
    <link rel="stylesheet" type="text/css" href="css/w2ui-2.0.min.css">
    <link rel="stylesheet" href="css/backdrop.css">
    <link rel="stylesheet" href="css/all.min.css" />
    <script src="js/cytoscape/OntologyViewerStyle.js"></script>
    <script src="lib/d3.min.js"></script>
    <script src="lib/papaparse.js"></script>
    <script src="lib/rdflib.min.js"></script>
    <script src="lib/uuid.min.js"></script>
    <script src="lib/index.umd.js"></script>
    <script src="lib/cytoscape.min.js"></script>
    <script src="lib/layout-base.js"></script>
    <script src="lib/cose-base.js"></script>
    <script src="lib/cytoscape-fcose.js"></script>
    <script src="lib/cytoscape-undo-redo.js"></script>
    <script src="lib/cytoscape-expand-collapse.js"></script>
    <script src="lib/popper.js"></script>
    <script src="lib/cytoscape-popper.min.js"></script>
    <script src="lib/tippy-bundle.iife.js"></script>
    <script src="lib/w2ui-2.0.min.js"></script>
    <script src="lib/layout-base.js"></script>
    <script src="lib/cola.min.js"></script>
    <script src="lib/cytoscape-cola.js"></script>
    <!-- Dagre.js (Required for cytoscape-dagre) -->
    <script src="lib/dagre.min.js"></script>
    <!-- Cytoscape-Dagre Extension -->
    <script src="lib/cytoscape-dagre.js"></script>
    <script src="lib/i18next.min.js"></script>


    <style>

       

        /* Style for select boxes */
        select {
            width: 100%;
            height: 150px;
            margin-top: 5px;
        }

        /* Hide the native file input */
        #fileInput,
        #fileInput2 {
            display: none;
        }


        #cy {
            width: 100%;
            height: 100%;
        }

    </style>
    <script>
        window.addEventListener('beforeunload', function (event) {
            // Cancel the event to trigger the confirmation dialog
            event.preventDefault();

            // Setting event.returnValue triggers the browser's confirmation dialog
            event.returnValue = 'Are you sure you want to leave? You may have unsaved changes.';

            // Note: The text inside event.returnValue will not be shown in modern browsers;
            // the browser will display a standard message instead.
        });
    </script>
</head>

<body>

    <div id="app" style="width: 100%; height: 70vh;">
        <div id="mainLayout" style="height: calc(100% - 40px);" />
    </div>
    <div class="tab-container" id="tabs"></div>
    <div style="height: 100px;" id="output" style="display: block;"></div>

    <input type="file" name="name" id="inputfile" style="display:none" />
    <input type="file" name="name" id="inputinferred" style="display:none" />
    <input type="file" name="name" id="load-from-inp" style="display:none" />
    <script type="module">
        var mainMenu;
        var removed;
        const resources = {
            en: {
                translation: {
                    tabs: {
                        triplesTab: "Triples",
                        classesTab: "Classes",
                        classEquivalenceTab: "Equivalence Classes",
                        objectPropertiesTab: "Obj. Properties",
                        dataPropertiesTab: "Data Properties",
                        namedIndividualsTab: "Individuals",
                        isaRelationsTab: "Individual Typing",
                        classSubsumptionTab: "Class Subsumption",
                        propertySubsumptionTab: "Property Subsumption",
                        propertyEquivalenceTab: "Property Equivalence",
                        propertyInverseTab: "Inverse Properties",
                        individualRelationsTab: "Individual Relations",
                        domainsTab: "Domains",
                        rangesTab: "Ranges",
                        triplesLabel: "Triplets trouvés",
                        classesLabel: "Found OWL Classes",
                        classEquivalenceLabel: "Equivalence classes between properties",
                        objectPropertiesLabel: "Found object properties",
                        dataPropertiesLabel: "Found datatype properties",
                        namedIndividualsLabel: "Found NamedIndividuals",
                        isaRelationsLabel: "Individuals typring Relations",
                        classSubsumptionLabel: "Classes subsumption relations",
                        propertySubsumptionLabel: "Properties subsumption relations",
                        propertyEquivalenceLabel: "Properties equivalence relations",
                        propertyInverseLabel: "Properties inverse relations",
                        individualRelationsLabel: "Relations between individuals",
                        domainsLabel: "Domain declarations",
                        rangesLabel: "Tange declarations",
                    },
                    menu: {
                        language: "Language",
                        fr: "🇫🇷 French",
                        en: "🇬🇧 English",
                        owl: "OWL File",
                        open: "Open",
                        importinferred: "Import inferred axioms as ontology",
                        savegraph: "Save Graph",
                        loadgraph: "Load Graph",
                        exportjson: "Export Json",
                        expandCollapse: "Expand/Collapse",
                        nodes: "Nodes",
                        expandAllNodes: "Expand All",
                        collapseAllNodes: "Collapse All",
                        expandSelectedNodes: "Expand Selected",
                        collapseSelectedNodes: "Collapse Selected",
                        expandSelectedNodesRecursively: "Expand Selected Recursively",
                        collapseSelectedNodesRecursively: "Collapse Selected Recursively",
                        edges: "Edges",
                        expandAllEdges: "Expand All",
                        collapseAllEdges: "Collapse All",
                        expandSelectedEdges: "Expand Selected",
                        collapseSelectedEdges: "Collapse Selected",
                        collapseEdgesBetweenNodes: "Reduce Between Selected Nodes",
                        expandEdgesBetweenNodes: "Expand Between Selected Nodes",
                        rendering: "Rendering",
                        renderingnodeirishortname: "Render by Entity IRI Short Name(id)",
                        noderenderinglabel: "Render by Label(RDFS Label)",
                        noderenderingprefix: "Render by prefixed name",
                        noderenderingannotation: "Render by annotation property",
                        noderenderingcustom: "Customed rendering",
                        edgeirishortName: "Render by Property IRI Short Name(id)",
                        edgerenderingprefixName: "Render by prefixed name",
                        edgerenderinglabel: "Render by Label(RDFS Label)",
                        edgerenderingannotationProperty: "Render by annotation property",
                        edgerenderingcustom: "Customed rendering",
                        label: "Label",
                        prefixName: "Prefix Name",
                        annotationProperty: "Annotation Property",
                        customRendering: "Custom Rendering",
                        display: "Display",
                        showowlconstructs: "Show OWL Constructs Nodes",
                        showisa: "Show isa as link",
                        showdomainrange: "Show domain and range as nodes",
                        showlabelasnode: "Show labels as nodes",
                        showlabelasedge: "Show labels as edges",
                        showannotationasnode: "Show annotations as nodes",
                        showannotationasedge: "Show annotations as edges",
                        viewpoint: "Viewpoints",
                        individual: "Individuals",
                        ontology: "Ontologies",
                        sop: "Subject Object Properties",
                        data: "Data",
                        layout: "Layouts",
                        fcose: "Fcose",
                        grid: "Grid",
                        circle: "Circle",
                        cose: "Cose",
                        breadthfirst: "Breadthfirst",
                        concentric: "Concentric",
                        random: "Random",
                        cola: "Cola",
                        dagre: "Dagre",
                        showhidegrabifydelete: "Actions on graph elements",
                        showhide: "Show/Hide",
                        hideselected: "Hide Selected",
                        hidenonselected: "Hide Non Selected",
                        unhideall: "Unhide All",
                        grabifyungrabify: "Grabify/Ungrabify",
                        ungrabifyselected: "Ungrabify Selected",
                        ungrabifynonselected: "Ungrabify Non Selected",
                        grabifyselected: "Grabify Selected",
                        grabifynonselect: "Grabify Non Selected",
                        lockunlock: "Lock/Unlock",
                        lockselected: "Lock Selected",
                        locknonselected: "Lock Non Selected",
                        unlockselected: "Unlock Selected",
                        unlocknonselect: "Unlock Non Select",
                        removerestore: "Remove Restore",
                        removeselected: "Remove Selected",
                        removeunselected: "Remove Unselected",
                        removeall: "Remove All",
                        restore: "Restore"
                    },
                    confirm: {
                        replacegraph: "Do you want to replace the current graph? If yes, current graph will be removed, if no, it will be merged with the import.",
                        rdfinplaceofowl: "Do you want to show RDF triples in place of OWL?"
                    },
                    alert: {
                        selectowlinferred: "Please select the inferred OWL File",
                        selectowl: "Please select you OWL File"
                    }
                }
            },
            fr: {
                translation: {
                    tabs: {
                        triplesTab: "Triplets",
                        classesTab: "Classes",
                        classEquivalenceTab: "Équivalence Classes",
                        objectPropertiesTab: "Propriétés Obj.",
                        dataPropertiesTab: "Propriétés Données",
                        namedIndividualsTab: "Individus",
                        isaRelationsTab: "Typage Individus",
                        classSubsumptionTab: "Subsomption Classes",
                        propertySubsumptionTab: "Subsomption Prop.",
                        propertyEquivalenceTab: "Équivalence Prop.",
                        propertyInverseTab: "Propriétés Inverses",
                        individualRelationsTab: "Relations Individus",
                        domainsTab: "Domaines",
                        rangesTab: "Portées",
                        triplesLabel: "Found triples",
                        classesLabel: "Classes OWL trouvées",
                        classEquivalenceLabel: "Classes d'équivalence entre propriétés",
                        objectPropertiesLabel: "Propriétés de type objet trouvées",
                        dataPropertiesLabel: "Propriétés de type données trouvées",
                        namedIndividualsLabel: "Individus nommés OWL trouvés",
                        isaRelationsLabel: "Relations de typage d'individus",
                        classSubsumptionLabel: "Relations de subsomption entre classes",
                        propertySubsumptionLabel: "Relations de subsomption entre propriétés",
                        propertyEquivalenceLabel: "Relations d'équivalence entre propriétés",
                        propertyInverseLabel: "Relations inverses entre propriétés",
                        individualRelationsLabel: "Relations entre individus",
                        domainsLabel: "Déclarations de domaines",
                        rangesLabel: "Déclarations de portées",

                    },
                    menu: {
                        language: "Langage",
                        fr: "🇫🇷 Français",
                        en: "🇬🇧 English",
                        owl: "Fichier OWL",
                        open: "Ouvrir",
                        importinferred: "Import des axiomes inférré de l'ontologie",
                        savegraph: "Sauve Graphe",
                        loadgraph: "Charge Graphe",
                        exportjson: "Exporte Json",
                        expandCollapse: "Développer/Réduire",
                        nodes: "Nœuds",
                        expandAllNodes: "Tout développer",
                        collapseAllNodes: "Tout réduire",
                        expandSelectedNodes: "Développer sélectionnés",
                        collapseSelectedNodes: "Réduire sélectionnés",
                        expandSelectedNodesRecursively: "Développer sélectionnés récursivement",
                        collapseSelectedNodesRecursively: "Réduire sélectionnés récursivement",
                        edges: "Arêtes",
                        expandAllEdges: "Tout développer",
                        collapseAllEdges: "Tout réduire",
                        expandSelectedEdges: "Développer sélectionnés",
                        collapseSelectedEdges: "Réduire sélectionnés",
                        collapseEdgesBetweenNodes: "Réduire entre les noeuds sélectionnés",
                        expandEdgesBetweenNodes: "Développer entre les noeuds sélectionnés",
                        rendering: "Rendu",
                        renderingnodeirishortname: "Nom court IRI",
                        label: "Étiquette",
                        prefixName: "Nom du préfixe",
                        annotationProperty: "Propriété d’annotation",
                        customRendering: "Rendu personnalisé",
                        display: "Affichage",
                        showowlconstructs: "... des nœuds OWL",
                        showisa: "... de 'isa' comme lien",
                        showdomainrange: "... des domaines et portées comme nœuds",
                        showlabelasnode: "... des labels comme noeuds",
                        showlabelasedge: "... des labels comme liens",
                        showannotationasnode: "... des annotations comme noeuds",
                        showannotationasedge: "... des annotations comme liens",
                        viewpoint: "Points de vue",
                        individual: "Individus",
                        ontology: "Ontologies",
                        sop: "Propriétés sujet-objet",
                        data: "Données",
                        layout: "Mises en page",
                        fcose: "Fcose",
                        grid: "Grille",
                        circle: "Cercle",
                        cose: "Cose",
                        breadthfirst: "Parcours en largeur",
                        concentric: "Concentrique",
                        random: "Aléatoire",
                        cola: "Cola",
                        dagre: "Dagre",
                        showhidegrabifydelete: "Actions sur éléments du graphe",
                        showhide: "Montrer/Cacher",
                        hideselected: "Cacher les sélectionnés",
                        hidenonselected: "Cacher les non sélectionnés",
                        unhideall: "Révéler tout",
                        grabifyungrabify: "Activer/Désactiver la prise",
                        ungrabifyselected: "Libérer la sélection",
                        ungrabifynonselected: "Libérer les non sélectionnés",
                        grabifyselected: "Prendre la sélection",
                        grabifynonselect: "Prendre les non sélectionnés",
                        lockunlock: "Verrouiller/Déverrouiller",
                        lockselected: "Verrouiller la sélection",
                        locknonselected: "Verrouiller les non sélectionnés",
                        unlockselected: "Déverrouiller la sélection",
                        unlocknonselect: "Déverrouiller les non sélectionnés",
                        removerestore: "Supprimer/Restaurer",
                        removeselected: "Supprimer la sélection",
                        removeunselected: "Supprimer les non sélectionnés",
                        removeall: "Tout supprimer",
                        restore: "Restaurer",
                        rendering: "Rendu",
                        renderingnodeirishortname: "Rendu par Nom Court de l'IRI de l'Entité (id)",
                        noderenderinglabel: "Rendu par Libellé (RDFS Label)",
                        noderenderingprefix: "Rendu par Nom Préfixé",
                        noderenderingannotation: "Rendu par Propriété d'Annotation",
                        noderenderingcustom: "Rendu Personnalisé",
                        edgeirishortName: "Rendu par Nom Court de l'IRI de la Propriété (id)",
                        edgerenderingprefixName: "Rendu par Nom Préfixé",
                        edgerenderinglabel: "Rendu par Libellé (RDFS Label)",
                        edgerenderingannotationProperty: "Rendu par Propriété d'Annotation",
                        edgerenderingcustom: "Rendu Personnalisé"
                    },
                    confirm: {
                        replacegraph: "Voulez vous remplacer le graphe courant? Sinon l'import sera fusionné avec le graphe courant.",
                        rdfinplaceofowl: "Voulez vous visualizer le graphe RDF au lien de l'ontologie OWL?   "
                    }
                    ,
                    alert: {
                        selectowlinferred: "Veuillez sélectionner le fichier OWL inferred.",
                        selectowl: "Veuillez sélectionner un fichier OWL."
                    }
                }
            }
        };


        function doElemsMultiTypes(elems) {
            const classDict = {};
            for (let i = 0; i < elems.length; i++) {
                classDict[elems[i].data('edgeType')] = true;
            }
            return Object.keys(classDict).length > 1;
        }
        function exportVisibleGraphToFile(cy) {
            let graphData = [];

            // Extract visible nodes
            cy.nodes(':visible').forEach(node => {
                let nodeData = {
                    data: {
                        id: node.id(),
                        label: node.data('label'),
                    }
                };

                let parent = node.parent();
                if (parent.length > 0) {
                    nodeData.data.parent = parent.id();
                }

                let classes = node.classes();
                if (classes) {
                    nodeData.classes = classes;
                }

                graphData.push(nodeData);
            });

            // Extract visible edges
            cy.edges(':visible').forEach(edge => {
                let edgeData = {
                    data: {
                        id: edge.id(),
                        source: edge.source().id(),
                        target: edge.target().id(),
                        label: edge.data('label'),
                        type: edge.data('type')
                    },
                    classes: edge.classes() // Récupération directe des classes existantes
                };

                let edgeType = edge.data('edgeType');
                if (edgeType) {
                    edgeData.data.edgeType = edgeType;
                }

                graphData.push(edgeData);
            });


            // Convertir en JSON et créer un Blob
            let jsonString = JSON.stringify(graphData, null, 2);
            let blob = new Blob([jsonString], { type: "application/json" });

            // Créer un lien de téléchargement
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            var filename = "owl.json"
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        i18next.init({
            lng: "fr", // Default language
            fallbackLng: "en", // Fallback language
            resources: resources // Use in-memory translations
        })
        function changeLanguage(lang) {
            i18next.changeLanguage(lang, () => {
                updateToolbarTranslations();
                updateTabsTranslations();
            });
        }

     



        function updateMenu() {
            w2ui.mainMenu.items.forEach(item => {
                item.text = i18next.t(item.text); // Translate
            });
            w2ui.mainMenu.refresh(); // Refresh UI
        }

        function addNewMenuItem() {

            mainMenu.items.push({
                type: "button",
                id: "newItem",
                text: i18next.t("menu.newItem"),
                icon: "fa fa-star"
            });

            mainMenu.refresh();
            updateToolbarTranslations(); // Ensure default language is applied to menu items  

        }

  


        function updateToolbarTranslations() {
            mainMenu.items.forEach(item => {

                if (item.id in i18next.t("menu", { returnObjects: true })) {
                    item.text = i18next.t(`menu.${item.id}`);
                    //  console.log(item.id)
                    // console.log(item.id + " -> " + item.text)
                    if (item.items) {
                        item.items.forEach(subItem => {
                            if (subItem.id in i18next.t("menu", { returnObjects: true })) {
                                subItem.text = i18next.t(`menu.${subItem.id}`);
                            }
                            // console.log(subItem.id + " -> " + subItem.text)
                            if (subItem.items) {
                                subItem.items.forEach(subSubItem => {
                                    if (subSubItem.id in i18next.t("menu", { returnObjects: true })) {
                                        subSubItem.text = i18next.t(`menu.${subSubItem.id}`);
                                    }
                                    //  console.log(subSubItem.id + " -> " + subSubItem.text)
                                });
                            }
                        });
                    }
                }

            });

            mainMenu.refresh(); // Apply the changes
        }
        var groupEdges = true;
        var allowNestedEdgeCollapse = true;
        function getEdgeOptions() {
            var groupEdgesOfSameTypeOnCollapse = groupEdges;
            var allowNestedEdgeCollapse = allowNestedEdgeCollapse;

            return { groupEdgesOfSameTypeOnCollapse: groupEdgesOfSameTypeOnCollapse, allowNestedEdgeCollapse: allowNestedEdgeCollapse };
        }

       

        const script = document.createElement("script");
        script.src = "lib/cytoscape-cola.js";
        script.onload = function () {
            console.log("Cytoscape-Cola loaded successfully");
            cytoscape.use(cytoscapeCola);
        };
        document.head.appendChild(script);

        const script2 = document.createElement("script");
        script2.src = "lib/cytoscape-dagre.js";
        script2.onload = function () {
            console.log("Cytoscape-Dagre loaded successfully");
            cytoscape.use(cytoscapeDagre);
        };

        document.head.appendChild(script2);
        function applyDagreLayout(rankDir = 'TB') { // Default to 'Top-Bottom'
            let layout = cy.layout({
                name: 'dagre',
                rankDir: rankDir, // Accepts 'TB' (top-bottom), 'LR' (left-right), etc.
                animate: true
            });

            layout.run(); // Apply layout
        }

        var groupEdges = true;
        var allowNestedEdgeCollapse = true;
  
        // Function to toggle the icon between checked and unchecked states

        function toggleIcon(itemId) {
            let item = w2ui.toolbar.get(itemId);
            let newIcon = item.icon === 'fa fa-square' ? 'fa fa-check-square' : 'fa fa-square'; // Toggle between square and check-square

            // Update the item with the new icon
            w2ui.toolbar.set(itemId, { icon: newIcon });
        }
        // Fonction pour changer le layout
        function changeLayout(layoutName) {
            cy.layout({ name: layoutName, animate: true, fit: true, padding: 10 }).run();
        }

        // Function for reading files - will be updated with a more sophisticated one
        function readTxtFile(file, cb) {
            const fileReader = new FileReader();
            fileReader.onload = () => {
                try {
                    cb(fileReader.result);
                } catch (error) {
                    logger.error('Given file is not suitable.', error);
                }
            };
            fileReader.onerror = (error) => {
                logger.error('File could not be read!', error);
                fileReader.abort();
            };
            fileReader.readAsText(file);
        }

        function getMenuItems() {
            return [
                {
                    type: "menu", id: "owl", text: i18next.t("menu.owl"), icon: "fa fa-folder-open",
                    items: [
                        { id: "open", text: i18next.t("menu.open") },
                        { id: "importinferred", text: i18next.t("menu.importinferred") },
                        { type: 'break' },
                        { id: "savegraph", text: i18next.t("menu.savegraph") },
                        { id: "loadgraph", text: i18next.t("menu.loadgraph") },
                        { type: 'break' },
                        { id: "exportjson", text: i18next.t("menu.exportjson") }
                    ]
                },
                {
                    type: "menu", id: "expandCollapse", text: i18next.t("menu.expandCollapse"), icon: "fa fa-object-group",
                    items: [
                        {
                            id: "nodes", text: i18next.t("menu.nodes"),
                            items: [
                                { id: "expandAllNodes", text: i18next.t("menu.expandAllNodes") },
                                { id: "collapseAllNodes", text: i18next.t("menu.collapseAllNodes") },
                                { id: "expandSelectedNodes", text: i18next.t("menu.expandSelectedNodes") },
                                { id: "collapseSelectedNodes", text: i18next.t("menu.collapseSelectedNodes") },
                                { id: "expandSelectedNodesRecursively", text: i18next.t("menu.expandSelectedNodesRecursively") },
                                { id: "collapseSelectedNodesRecursively", text: i18next.t("menu.collapseSelectedNodesRecursively") },
                            ]
                        },
                        {
                            id: "edges", text: i18next.t("menu.edges"),
                            items: [
                                { id: "expandAllEdges", text: i18next.t("menu.expandAllEdges") },
                                { id: "collapseAllEdges", text: i18next.t("menu.collapseAllEdges") },
                                { id: "expandSelectedEdges", text: i18next.t("menu.expandSelectedEdges") },
                                { id: "collapseSelectedEdges", text: i18next.t("menu.collapseSelectedEdges") },
                                { id: "collapseEdgesBetweenNodes", text: i18next.t("menu.collapseEdgesBetweenNodes") },
                                { id: "expandEdgesBetweenNodes", text: i18next.t("menu.expandEdgesBetweenNodes") },

                            ]
                        }
                    ]
                },
                {
                    type: 'menu-check', id: 'rendering', text: i18next.t("menu.rendering"), icon: 'fa fa-eye', disabled: false,
                    items: [
                        { text: '-- Node' },

                        { id: 'renderingnodeirishortname', text: i18next.t("menu.renderingnodeirishortname"), disabled: true },
                        { id: 'noderenderinglabel', text: i18next.t("menu.noderenderinglabel"), disabled: true },
                        { id: 'noderenderingprefix', text: i18next.t("menu.noderenderingprefix"), disabled: true },
                        { id: 'noderenderingannotation', text: i18next.t("menu.noderenderingannotation"), disabled: true },
                        { id: 'noderenderingcustom', text: i18next.t("menu.noderenderingcustom"), disabled: true }

                        ,
                        { text: '-- Edge' },

                        { id: 'edgeirishortName', text: i18next.t("menu.edgeirishortName"), disabled: true },
                        { id: 'edgerenderingprefixName', text: i18next.t("menu.edgerenderingprefixName"), disabled: true },
                        { id: 'edgerenderinglabel', text: i18next.t("menu.edgerenderinglabel"), disabled: true },
                        { id: 'edgerenderingannotationProperty', text: i18next.t("menu.edgerenderingannotationProperty"), disabled: true },
                        { id: 'edgerenderingcustom', text: i18next.t("menu.edgerenderingcustom"), disabled: true }
                    ]
                },
                {
                    type: 'menu', id: 'showhidegrabifydelete', text: i18next.t("menu.showhidegrabifydelete"), icon: 'fa fa-eye',
                    items: [
                        {
                            id: 'showhide', text: i18next.t("menu.showhide"),
                            items: [
                                { id: 'hideselected', text: i18next.t("menu.hideselected") },
                                { id: 'hidenonselected', ttext: i18next.t("menu.hidenonselected") },
                                { id: 'unhideall', text: i18next.t("menu.unhideall") },
                            ]
                        },
                        {
                            id: 'grabifyungrabify', text: i18next.t("menu.ungrabifyselected"),
                            items: [
                                { id: 'ungrabifyselected', text: i18next.t("menu.ungrabifyselected") },
                                { id: 'ungrabifynonselected', text: i18next.t("menu.ungrabifynonselected") },
                                { id: 'grabifyselected', text: i18next.t("menu.grabifyselected") },
                                { id: 'grabifynonselect', text: i18next.t("menu.grabifynonselect") }
                            ]
                        },
                        {
                            id: 'lockunlock', text: i18next.t("menu.lockunlock"),
                            items: [
                                { id: 'lockselected', text: i18next.t("menu.lockselected") },
                                { id: 'locknonselected', text: i18next.t("menu.locknonselected") },
                                { id: 'unlockselected', text: i18next.t("menu.unlockselected") },
                                { id: 'unlocknonselect', text: i18next.t("menu.unlocknonselect") }
                            ]
                        },
                        {
                            id: 'removerestore', text: i18next.t("menu.removerestore"),
                            items: [
                                { id: 'removeselected', text: i18next.t("menu.removeselected") },
                                { id: 'removeunselected', text: i18next.t("menu.removeunselected") },
                                { id: 'removeall', text: i18next.t("menu.removeall") },
                                { id: 'restore', text: i18next.t("menu.restore") },

                            ]
                        }
                    ]
                },
                {
                    type: 'menu-check', id: 'display', text: i18next.t('display'), icon: 'fa fa-eye', disabled: false,
                    items: [
                        { id: 'showowlconstructs', text: i18next.t('showowlconstructs'), disabled: true },
                        { id: 'showisa', text: i18next.t('showisa'), disabled: true },
                        { id: 'showdomainrange', text: i18next.t('showdomainrange'), disabled: true },
                        { id: 'showlabelasnode', text: i18next.t('showlableasnode'), disabled: true },
                        { id: 'showlabelasedge', text: i18next.t('showlabelasedge'), disabled: true },
                        { id: 'showannotationasnode', text: i18next.t('showannotationasnode'), disabled: true },
                        { id: 'showannotationasedge', text: i18next.t('showannotationasedge'), disabled: true }

                    ],
                },
                {
                    type: 'menu-check', id: 'viewpoint', text: i18next.t('viewpoint'), icon: 'fa fa-eye', disabled: false,
                    items: [
                        { id: 'individual', text: i18next.t('individual'), disabled: true },
                        { id: 'ontology', text: 'ontology', disabled: true },
                        { id: 'sop', text: 'Subject Object Properties', disabled: true },
                        { id: 'data', text: 'Data', disabled: true },
                    ]
                },
                {
                    type: "menu-radio", id: "layout", text: i18next.t("menu.layout"), icon: "fa fa-eye",
                    selected: "fcose",
                    items: [
                        { id: "fcose", text: i18next.t("menu.fcose") },
                        { id: "grid", text: i18next.t("menu.grid") },
                        { id: "circle", text: i18next.t("menu.circle") },
                        { id: "cose", text: i18next.t("menu.cose") },
                        { id: "breadthfirst", text: i18next.t("menu.breadthfirst") },
                        { id: "concentric", text: i18next.t("menu.concentric") },
                        { id: "random", text: i18next.t("menu.random") },
                        { id: "cola", text: i18next.t("menu.cola") },
                        { id: "dagre", text: i18next.t("menu.dagre") }
                    ]
                },
                {
                    type: "menu-radio", id: "language", text: i18next.t("menu.language"), icon: "fa fa-eye",
                    selected: "fr",
                    items: [
                        { id: "fr", text: i18next.t("fr") },
                        { id: "en", text: i18next.t("en") },
                    ]
                }
            ];

        }
        function initializeToolbar() {
            if (w2ui.mainMenu) return; // Prevent multiple initializations
            mainMenu = new w2toolbar({
                name: "mainMenu",
                items: getMenuItems(),
                onClick: function (event) {
                    handleMenuAction(event); // Handle menu actions
                }
            });
            updateToolbarTranslations()
            return mainMenu;
        }


        function handleMenuAction(event) {
            switch (event.target) {
                case 'view:nodeRendering':
                    break;
                case "view.edgeRendering":
                    console.log("createEdgeRenderingSubMenu();")
                    break;
                case 'owl:open':
                    const file = document.getElementById('inputfile');
                    file.value = '';
                    file.click();
                    break;
                case 'owl:importinferred':
                    const file2 = document.getElementById('inputinferred')
                    file2.value = '';
                    file2.click();
                    break;
                case 'owl:loadgraph':
                    const el = document.getElementById('load-from-inp');
                    el.value = '';
                    el.click();
                    break;
                case 'owl:exportjson':
                    exportVisibleGraphToFile(cy);
                    break;
                case 'owl:savegraph':
                    if (typeof cy === 'undefined' || !cy) {
                        console.warn("Cytoscape instance (cy) is not initialized.");
                        w2alert("Graph non initialisé. Impossible de sauvegarder.");
                        break;
                    }
                    var fileNameToSave = "myGraph.archicg";
                    w2prompt({
                        label: 'Enter value',
                        value: fileNameToSave,
                        attrs: 'size=6'
                    })
                        .change((event) => {
                            fileNameToSave = event.detail.originalEvent.target.value;
                        })
                        .ok(() => {
                            var visibleElements = cy.elements(':visible'); // Sélectionne uniquement les éléments visibles
                            api.saveJson(visibleElements, fileNameToSave);
                        });
                    break;
                case 'expandCollapse:expandAllNodes':
                    api.expandAll()
                    api.collapseAllEdges(getEdgeOptions())
                    break;
                case 'expandCollapse:collapseAllNodes':
                    api.collapseAll()
                    api.collapseAllEdges(getEdgeOptions())
                    break;
                case 'expandCollapse:expandSelectedNodes':
                    api.expand(cy.$(":selected"));
                    api.collapseAllEdges(getEdgeOptions())
                    break;
                case 'expandCollapse:collapseSelectedNodes':
                    api.collapse(cy.$(":selected"));
                    break;
                case 'expandCollapse:expandSelectedNodesRecursively':
                    api.expandRecursively(cy.$(":selected"));
                    api.collapseAllEdges(getEdgeOptions())
                    break;
                case 'expandCollapse:collapseSelectedNodesRecursively':
                    api.collapseRecursively(cy.$(":selected"));
                    break;
                case 'expandCollapse:expandAllEdges':
                    //  alert("expandAllEdges")
                    api.expandAllEdges(getEdgeOptions());
                    break;
                case 'expandCollapse:collapseAllEdges':
                    //  alert("collapseAllEdges")
                    var options = {}
                    api.collapseAllEdges(getEdgeOptions())
                    break;
                case 'expandCollapse:expandSelectedEdges':
                    api.expandEdges(cy.$("edge:selected"), getEdgeOptions());
                    break;
                case 'expandCollapse:collapseSelectedEdges':
                    api.collapseEdges(cy.$("edge:selected"), getEdgeOptions());
                    break;
                case 'expandCollapse:collapseEdgesBetweenNodes':
                    api.collapseEdgesBetweenNodes(cy.$("node:selected"), getEdgeOptions());
                    break;
                case 'expandCollapse:expandEdgesBetweenNodes':
                    api.expandEdgesBetweenNodes(cy.$("node:selected"), getEdgeOptions());
                    break;
                case 'isaEdges':
                    setTypingDisplay('isaEdges');
                    break;
                case 'postfixNotation':
                    setTypingDisplay('postfixNotation');
                    break;
                case 'dataAsNodes':
                    setDataDisplay('dataAsNodes');
                    break;
                case 'dataAsEdges':
                    setDataDisplay('dataAsEdges');
                    break;
                case 'datatypeAsNodes':
                    setDatatypeDisplay('datatypeAsNodes');
                    break;
                case 'datatypeOnEdges':
                    setDatatypeDisplay('datatypeOnEdges');
                    break;
                case 'layout:fcose':
                    changeLayout('fcose');
                    break;
                case 'layout:grid':
                    changeLayout('grid');
                    break;
                case 'layout:circle':
                    changeLayout('circle');
                    break;
                case 'layout:cose':
                    changeLayout('cose');
                    break;
                case 'layout:breadthfirst':
                    changeLayout('breadthfirst');
                    break; case 'layout:concentric':
                    changeLayout('concentric');
                    break;
                case 'layout:random':
                    changeLayout('random');
                    break;
                case 'layout:cola':
                    changeLayout('cola');
                    break;
                case 'layout:dagre':
                    applyDagreLayout('TB');
                    break;
                case 'language:fr':
                    changeLanguage('fr')
                    break;
                case 'language:en':
                    changeLanguage('en')
                    break;

                case 'showhidegrabifydelete:showhide':
                    break;
                case 'showhidegrabifydelete:hideselected':
                    var eles = cy.$(":selected");
                    eles = eles.filter(":visible");
                    eles = eles.union(eles.connectedEdges());
                    eles.unselect();
                    console.log(eles)
                    eles.css('visibility', 'hidden');
                    eles.css('display', 'none');
                    break;
                case 'showhidegrabifydelete:hidenonselected':
                    var unselected = cy.nodes(":unselected");
                    var selected = cy.nodes(":selected");
                    unselected.forEach(function (node) {
                        if (node.descendants(node.id()).intersection(selected).length == 0) {
                            node.css('visibility', 'hidden');
                            node.css('display', 'none');
                        }
                    })
                    break;
                case 'showhidegrabifydelete:unhideall':
                    var eles = cy.filter(":hidden");
                    var connectedEdges = eles.connectedEdges(function (edge) {
                        if ((edge.source().visible() || eles.contains(edge.source())) && (edge.target().visible() || eles.contains(edge.target()))) {
                            return true;
                        }
                        return false;
                    });
                    eles = eles.union(connectedEdges);
                    eles.unselect();
                    eles.style('visibility', 'visible');
                    eles.style('display', 'element');
                    break;
                case 'showhidegrabifydelete:grabifyungrabify':
                    break;
                case 'showhidegrabifydelete:ungrabifyselected':
                    var nodes = cy.nodes(":selected").ungrabify();
                    ungrabifiedNodes = ungrabifiedNodes.concat(nodes);
                    nodes.unselect();
                    break;
                case 'showhidegrabifydelete:ungrabifynonselected':
                    var nodes = cy.nodes(":unselected").ungrabify();
                    ungrabifiedNodes = ungrabifiedNodes.concat(nodes);
                    nodes.unselect();
                    break;
                case 'showhidegrabifydelete:grabifyselected':
                    var nodes = cy.nodes(":selected").grabify();
                    ungrabifiedNodes = ungrabifiedNodes.filter(function (el) {
                        return !nodes.includes(el);
                    });
                    nodes.unselect();
                    break;
                case 'showhidegrabifydelete:grabifynonselect':
                    var nodes = cy.nodes(":unselected").grabify();
                    ungrabifiedNodes = ungrabifiedNodes.filter(function (el) {
                        return !nodes.includes(el);
                    });
                    nodes.unselect();
                    break;
                case 'showhidegrabifydelete:lockunlock':
                    break;
                case 'showhidegrabifydelete:lockselected':
                    var nodes = cy.nodes(":selected").lock();
                    lockedNodes = lockedNodes.concat(nodes);
                    nodes.unselect();
                    break;
                case 'showhidegrabifydelete:locknonselected':
                    var nodes = cy.nodes(":unselected").lock();
                    lockedNodes = lockedNodes.concat(nodes);
                    nodes.unselect();
                    break;
                case 'showhidegrabifydelete:unlockselected':
                    var nodes = cy.nodes(":selected").unlock();
                    lockedNodes = lockedNodes.filter(function (el) {
                        return !nodes.includes(el);
                    });
                    nodes.unselect();
                    break;
                case 'showhidegrabifydelete:unlocknonselect':
                    var nodes = cy.nodes(":unselected").unlock();
                    lockedNodes = lockedNodes.filter(function (el) {
                        return !nodes.includes(el);
                    });
                    nodes.unselect();
                    break;

                case 'showhidegrabifydelete:removeselected':
                    //   if (undoRedo) { ur.do("remove", elements) } else { removed = removed.union(cy.remove(elements)); }

                    removed = cy.remove(cy.$(":selected"));

                    break;
                case 'showhidegrabifydelete:removeunselected':
                    //  if (undoRedo) { ur.do("remove", elements) } else { removed = removed.union(cy.remove(elements)); }
                    removed = cy.remove(cy.$(":unselected"));

                    break;
                case 'showhidegrabifydelete:removeall':
                    //    if (undoRedo) { ur.do("remove", elements) } else { removed = removed.union(cy.remove(elements)); }
                    removed = cy.remove(cy.$());
                    break;
                case 'showhidegrabifydelete:restore':
                    removed.restore();
                    break;
            }
        }
        // Define the layout first
        let layout = new w2layout({
            //box: '#layout',
            name: 'mainLayout',
            panels: [
                { type: 'top', size: 50, style: 'border-bottom: 1px solid #ccc;' },
                { type: 'left', size: 200, style: 'border-right: 1px solid #ccc;' },
                { type: 'main', style: 'background: #f8f9fa;', html: '<div id="cy"></div> ' },
                {
                    type: 'right', size: 250, style: 'border-left: 1px solid #ccc;', html: `
                            ` },
                {
                    type: 'bottom', size: 50, style: 'border-top: 1px solid #ccc;', html: ``
                }
            ]
        })
        layout.render('#mainLayout'); // Render the layout in the container      
        w2ui.mainLayout.html('top', initializeToolbar());
        w2ui.mainLayout.html('bottom', "");

        // --- Placeholder Functions ---
        function Open() {
            console.log("Open...");
            // TODO: Implement file input and OWL parsing
        }

        function importInferred() {
            console.log("Import OWL file with inference...");
            // TODO: Implement inference-based OWL loading
        }

        function expandAllNodes() {
            console.log("Expanding all nodes...");
            // TODO: Call Cytoscape.js expand function
        }

        function collapseAllNodes() {
            console.log("Collapsing all nodes...");
            // TODO: Call Cytoscape.js collapse function
        }

        function expandSelectedNodes() {
            console.log("Expanding selected nodes...");
            // TODO: Expand only selected nodes in Cytoscape.js
        }

        function collapseSelectedNodes() {
            console.log("Collapsing selected nodes...");
            // TODO: Collapse only selected nodes in Cytoscape.js
        }

        function setTypingDisplay(mode) {
            console.log("Setting typing display mode:", mode);
            // TODO: Change the display style for types
        }

        function setDataDisplay(mode) {
            console.log("Setting data display mode:", mode);
            // TODO: Adjust visualization for annotations and data
        }

        function setDatatypeDisplay(mode) {
            console.log("Setting datatype display mode:", mode);
            // TODO: Adjust how datatypes are displayed (nodes or edges)
        }


        var nodes = [];
        var edges = [];
        var equivalenceGroups = new Map();


        function makePopper(ele) {
            // console.log("makePopper")
            let ref = ele.popperRef();
            ele.tippy = tippy(document.createElement('div'), {
                // popperInstance will be available onCreate
                lazy: false,
                followCursor: 'true',
                hideOnClick: false,
                flipOnUpdate: true,
                onShow(instance) {
                    instance.popperInstance.reference = ref
                },
            });
            ele.tippy.setContent(ele.id());
        }


        // Create Node Function
        function createNode(id, label, type, IRI, parent = null) {
            // Prepare the node data
            const nodeData = {
                id,
                label,
                type,
                IRI
            };
            // Add the parent only if it is defined
            if (parent) {
                nodeData.parent = parent;
            }
            // Push the node data to the array
            nodes.push({
                group: 'nodes',
                data: nodeData,
                classes: type
            });
            //   console.log(`I'm creating a node with id=${nodeData.id}`)
        }

        function updateNode(id, characteristics = {}) {
            // Find the node by id
            //alert ("updateNode:(" +id+")")
            const node = nodes.find(n => n.data.id === id);

            // If the node exists, update its characteristics
            if (node) {
                // Check if the object contains specific characteristics and update accordingly
                if (characteristics.functional) {
                    node.data.functional = true;
                    node.data.label = '→' + node.data.label;
                }
                if (characteristics.transitive) {
                    node.data.transitive = true;
                    node.data.label = '△' + node.data.label;
                }
                if (characteristics.inverseFunctional) {
                    node.data.inverseFunctional = true;
                    node.data.label = '←' + node.data.label;
                }
                if (characteristics.irreflexive) {
                    node.data.irreflexive = true;
                    node.data.label = '𐌗◯' + node.data.label;
                }
                if (characteristics.reflexive) {
                    node.data.reflexive = true;
                    node.data.label = '◯' + node.data.label;
                }
                if (characteristics.namedNodemetric) {
                    node.data.namedNodemetric = true;
                    node.data.label = '↔' + node.data.label;
                }
                if (characteristics.asymmetric) {
                    node.data.asymmetric = true;
                    node.data.label = '𐌗↔' + node.data.label;
                }
                //alert (JSON.stringify(node))
            }
        }

        function createEdge(id, label, source, target, type) {
            // Retrieve the style for the given type

            // Prepare the edge data
            const edgeData = {
                id,
                label,
                source,
                target,
                type,
                edgeType: type
            };

            // Push the edge data to the edges array
            edges.push({
                group: 'edges',
                data: edgeData,
                classes: type // Optional: Keep the class for additional styling
            });
        }

  
        // Fonction de validation RDF for s o p triples visualisation
        function validateRDF(store) {

            //initialisation du graphe
            cy.elements().remove();
            cy.add(nodes);
            edges.forEach(edge => {
                try {
                    // Add the edge directly using its existing data
                    cy.add({
                        group: 'edges',
                        data: edge.data,
                        classes: edge.classes
                    });
                } catch (error) {
                    console.warn(`Error adding edge ${edge.data.id}: ${error.message}`);

                    // Check and create missing source node
                    alert("blank source: " + edge.data.source)
                    if (cy.getElementById(edge.data.source).length === 0) {
                        cy.add({
                            group: 'nodes',
                            data: { id: edge.data.source },
                            classes: 'blank-node'
                        });
                        console.log(`Created blank node: ${edge.data.source}`);
                    }
                    console.log("blank target: " + edge.data.source)
                    // Check and create missing target node
                    if (cy.getElementById(edge.data.target).length === 0) {
                        cy.add({
                            group: 'nodes',
                            data: { id: edge.data.target },
                            classes: 'blank-node'
                        });
                        console.log(`Created blank node: ${edge.data.target}`);
                    }

                    // Retry adding the edge now that nodes exist
                    try {
                        cy.add({
                            group: 'edges',
                            data: edge.data,
                            classes: edge.classes
                        });
                    } catch (retryError) {
                        console.error(`Failed again to add edge ${edge.data.id}:`, retryError);
                    }

                }
            });
            console.log("Graph successfully imported into Cytoscape!");
            // Déplier tout au chargement
            api.expandAll();
            api.collapseAllEdges(getEdgeOptions())
        }

        // Fonction de validation OWL
        function validateOWL(store) {
            //initialisation du graphe
            cy.elements().remove();
            cy.add(nodes);
            edges.forEach(edge => {
                try {
                    // Add the edge directly using its existing data
                    cy.add({
                        group: 'edges',
                        data: edge.data,
                        classes: edge.classes
                    });
                } catch (error) {
                    // console.warn(`Error adding edge ${edge.data.id}: ${error.message}`);
                    // Check and create missing source node
                    console.log(edge.data)
                    if (cy.getElementById(edge.data.source).length === 0) {
                       // var parent = getPathFromIRI(edge.data.source)
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: edge.data.source,
                                label: "FunctionToBeDefined",//getLabelFromIRI(edge.data.source),
                              //  parent: parent,
                            },
                         //   classes: getOWLTypeFromPredicate(edge.classes, "subject")
                        });
                        
                    }

                    // Check and create missing target node
                    if (cy.getElementById(edge.data.target).length === 0) {
                        var parent = getPathFromIRI(edge.data.target);
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: edge.data.target,
                                label: "FunctionToBeDefined",//getLabelFromIRI(edge.data.target),
                             //   parent: parent// "http://data.europa.eu/m8g"
                            },
                          //  classes: getOWLTypeFromPredicate(edge.classes, "object")
                        });
                    }

                    // Retry adding the edge now that nodes exist
                    try {
                        cy.add({
                            group: 'edges',
                            data: edge.data,
                          //  classes: edge.classes
                        });
                    } catch (retryError) {
                        console.log(`Failed again to add edge ${edge.data.id}:`, retryError);
                    }

                }
            });
            // Déplier tout au chargement
            api.expandAll();
            api.collapseAllEdges(getEdgeOptions())
            //  cy.layout({ name: 'fcose', animate: true }).run();
            console.log("Graph successfully imported into Cytoscape!");
        }
        
        var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: [], // Ajoutez vos éléments ici
            style: OntologyViewerStyle,
            layout: {
                name: 'fcose',
                animate: true
            }
        });
        // Ajout des plugins
        var ur = cy.undoRedo();

        var api = cy.expandCollapse({
            layoutBy: { name: 'fcose', animate: true },
            fisheye: true,
            animate: 'end',
            undoable: true
        });

     
        cy.on('add', 'node, edge', (event) => {
            makePopper(event.target);
        });
        cy.on('mouseover', 'node, edge', (event) => {
            if (event.target.tippy) event.target.tippy.show();
        });
        cy.on('drag', 'node, edge', (event) => {
            if (event.target.tippy) event.target.tippy.popperInstance.update();
        });
        cy.on('mouseout', 'node, edge', (event) => {
            if (event.target.tippy) event.target.tippy.hide();
        });
       
        // Event listener for node or edge click
        cy.on('tap', 'node, edge', function (event) {
            var target = event.target;
            return;

            // Display the info panel
            var infoPanel = document.getElementById('infoPanel');
            infoPanel.style.display = 'block';

            // Create an HTML string for the data to be displayed
            var infoHtml = '';

            if (target.isNode()) {
                const CompoundNodeRelatedKeys = [
                    'expandcollapseRenderedStartX', 'expandcollapseRenderedStartY',
                    'expandcollapseRenderedCueSize',
                    'collapse',
                    'position-before-collapse',
                    'size-before-collapse',
                    'collapsedChildren',
                    'x-before-fisheye',
                    'y-before-fisheye',
                    'width-before-fisheye',
                    'height-before-fisheye',
                    'infoLabel'
                ];

                infoHtml += '<strong>Node Information</strong><br>';
                // Loop through node data and display as name: value
                var nodeData = target.data();
                for (var key in nodeData) {
                    if (nodeData.hasOwnProperty(key) && !CompoundNodeRelatedKeys.includes(key)) {
                        infoHtml += '<strong>' + key + '</strong>: ' + nodeData[key] + '<br>';
                    }
                }
            } else if (target.isEdge()) {
                infoHtml += '<strong>Edge Information</strong><br>';

                // Loop through edge data and display as name: value
                var edgeData = target.data();
                const CompoundEdgeRelatedKeys = [
                    'collapsedEdges',
                    'edgeType',
                    'directionType',
                    'originalEnds'
                ];
                for (var key in edgeData) {
                    if (edgeData.hasOwnProperty(key) && !CompoundEdgeRelatedKeys.includes(key)) {
                        infoHtml += key + ': ' + edgeData[key] + '<br>';
                    }
                }
            }

            // Update the panel content
            infoPanel.innerHTML = infoHtml;

            // Event listener for clicking outside the node or edge
            document.addEventListener('click', function outsideClickListener(e) {
                // Check if the click is outside the info panel or target (node or edge)
                if (!infoPanel.contains(e.target) && !target.contains(e.target)) {
                    infoPanel.style.display = 'none';
                    document.removeEventListener('click', outsideClickListener);
                }
            });
        });
        // Event listener for double-click on the Cy container (to hide the panel)
        cy.container().addEventListener('dblclick', function (event) {
            // Check if the double-click is outside of any node or edge
            infoPanel.style.display = 'none';
            api.collapseAllEdges(getEdgeOptions())

        });
        

        //// Loading files
        document.getElementById('load-from-inp').addEventListener('change', function () {
            readTxtFile(this.files[0], function (txt) {
                w2confirm('Do you want to replace? If yes, current graph will be removed, if no, it will be fusionned with the import)')
                    .yes(() => {
                        cy.$().remove();
                        api.loadJson(txt);
                        api.collapseAll();
                        api.collapseAllEdges(getEdgeOptions());
                    })
                    .no(() => {
                        api.loadJson(txt);
                        api.collapseAll();
                        api.collapseAllEdges(getEdgeOptions());
                    });
            })
        });

    </script>
</body>

</html>